<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_ifg_n33_bt">
  <title>LDAP Integration</title>
  <body>
    <section>Integrating with an external LDAP server <ol>
      <li>Ensure that domain_specific_drivers_enabled option is set to True in main configuration
        file template (roles/KEY-API/templates/keystone.conf.j2).</li>
      <li>Create YAML file which contains definition of LDAP server connection. Use
        roles/KEY-API/files/samples/keystone_configure_ldap_sample.yml as an example. Save the
        file, as, for example, /tmp/myldap.yml Please refer to [ldap] section of Keystone KIlo
        documentation for full option list and description:
        http://docs.openstack.org/kilo/config-reference/content/keystone-configuration-file.html</li>
      
      <li>Run reconfiguration playbook, passing a YAML file created at previous step as command
        line option:
        <codeblock>ansible-playbook -i hosts/verb_hosts keystone-reconfigure.yml -e@/tmp/myldap.yml
</codeblock></li>
      <li>Ensure that new domain was created for LDAP (Microsoft AD in this example), user and
        group records can be retrieved: <codeblock># Import environment variables suited for Keystone administration
$ source keystone.osrc
 
# Get list of domains
stack@hLinux:~$ openstack domain list
+----------------------------------+---------+---------+----------------------------------------------------------------------+
| ID                               | Name    | Enabled | Description                                                          |
+----------------------------------+---------+---------+----------------------------------------------------------------------+
| 6740dbf7465a4108a36d6476fc967dbd | heat    | True    | Owns users and projects created by heat                              |
| default                          | Default | True    | Owns users and tenants (i.e. projects) available on Identity API v2. |
| b2aac984a52e49259a2bbf74b7c4108b | ad      | True    | Dedicated domain for users managed by Microsoft AD server            |
+----------------------------------+---------+---------+----------------------------------------------------------------------+
 
# Get list of LDAP groups
stack@hLinux:~$ openstack group list --domain ad
+------------------------------------------------------------------+------------+
| ID                                                               | Name       |
+------------------------------------------------------------------+------------+
| 03976b0ea6f54a8e4c0032e8f756ad581f26915c7e77500c8d4aaf0e83afcdc6 | testgroup1 |
| 7ba52ee1c5829d9837d740c08dffa07ad118ea1db2d70e0dc7fa7853e0b79fcf | testgroup2 |
+------------------------------------------------------------------+------------+
 
# Get user record
stack@hLinux:~$ openstack user show testuser1 --domain ad
+-----------+------------------------------------------------------------------+
| Field     | Value                                                            |
+-----------+------------------------------------------------------------------+
| domain_id | b2aac984a52e49259a2bbf74b7c4108b                                 |
| id        | 05f107e4b1645c52c24a529e3fb464647e4075a31db3e51b34e1ed41116d7706 |
| name      | testuser1                                                        |
+-----------+------------------------------------------------------------------+
 
# Grant testuser1 admin role within LDAP domain. For demonstration purpose only - don't do this in production!
# Please note that due to current Openstack CLI limitation, we have to use user ID rather then user name
# when working with non-default domain.
stack@hLinux:~$ openstack role add admin --user 05f107e4b1645c52c24a529e3fb464647e4075a31db3e51b34e1ed41116d7706 --domain ad
stack@hLinux:~$ openstack role assignment list --user 05f107e4b1645c52c24a529e3fb464647e4075a31db3e51b34e1ed41116d7706 --domain ad
+----------------------------------+------------------------------------------------------------------+-------+---------+----------------------------------+
| Role                             | User                                                             | Group | Project | Domain                           |
+----------------------------------+------------------------------------------------------------------+-------+---------+----------------------------------+
| c0b1ee04cd0c44c4bf001da9585b107e | 05f107e4b1645c52c24a529e3fb464647e4075a31db3e51b34e1ed41116d7706 |       |         | b2aac984a52e49259a2bbf74b7c4108b |
+----------------------------------+------------------------------------------------------------------+-------+---------+----------------------------------+

</codeblock>
        <note>LDAP domain is read-only. This means that you can not create new user or group
          record in it. </note>
      </li>
      <li>Once LDAP user is granted appropriate role, it can authenticate within specified domain
        by setting appropriate OS_* environment variables for openstack CLI.</li>
    </ol>
    </section>
    <section>Adjusting WSGI and logging parameters To modify WSGI parameters (such as process counts
      for public and admin Keystone interfaces) and log levels, do the following: <ol>
        <li>Adjust respective parameters in
          roles/keystone-common/vars/keystone_deploy_config.yml.</li>
        <li>Run reconfiguration playbook:
          <codeblock>ansible-playbook -i hosts/verb_hosts keystone-reconfigure.yml</codeblock>
        </li>
        
      </ol>
    </section>
  </body>
</topic>
