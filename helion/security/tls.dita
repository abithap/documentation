<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_yym_nps_4t">
  <title>Enabling TLS for Public Endpoints</title>
  <body>

    <section id="intro">
      <p>
        <note><b>THIS DOCUMENT IS IN NO WAY READY FOR GA AND NEEDS MUCH UPDATING. ESPECIALLY WRT TO PORTS LISTED</b></note>
      </p>
      
      <p>The Transport Layer Security (TLS) protocol, successor of SSL, provides the mechanisms to
        ensure authentication, non-repudiation, confidentiality, and integrity of user
        communications to the HP Helion OpenStack services from public endpoints.</p>
      <p>OpenStack endpoints are HTTP (REST) services providing APIs to other OpenStack services on the
        management network. All traffic to OpenStack services coming in on the public endpoints are
        secured using TLS connections.</p>
      <p>The following secure service endpoints and their associated ports use TLS: [<b>NOTE THESE
          ENDPOINTS ARE NOT ALL SECURED. REVIEWERS PLEASE NOTE WHICH ARE</b>]</p>
      
      <codeblock>ceilometer          8777
cinder              8776
glance-api          9292
glance-registry     9191
heat-api            8004
heat-cfn            8000
heat-cloudwatch     8003
horizon             443
keystone-admin      35357
keystone-public     5000
neutron             9696
nova-novncproxy     6080
nova-metadata       8775
nova-api            8774
sherpa              21131
swift-proxy         8080</codeblock>



      <p>It is generally recommended that you provide a CA key and certificate generated from a
        well-known certificate authority during the installation process, so trust can be
        established using the certificate chain. This can be either a specific certificate/key
        generated for this deployment, a general certificate/key that is used for test deployments
        by that organization, or a delegated signing certificate from another PKI to enable the use
        of existing trust relationships between users and that PKI. Either way, the deployer must
        provide the CA certificate to the Helion users, to enable secure TLS and prevent certificate
        errors and warnings.</p>
      <p>The CA certificate/key pair must not be reused between deployments at different
        organizations, or in different deployments with differing levels of trust; for example, a
        public, untrusted Helion test system and an internal production system.</p>

    
      <p>If a self-signed certificate was created during the Helion OpenStack installation, you must
        install the generated certificate in your browser as a trusted CA to prevent messages about
        insecure connections when connecting to the Horizon IP address. This can be done by
        importing the eca.crt file from the seed VM as a trusted CA into your browser software.</p>
      <p>Each client must use this certificate to authenticate the connection. How you achieve this
        will depend on the client you are using. Below are some ways you can achieve this with the
        OpenStack command line tools using the 'nova list' command as an example. The easiest way to
        make sure the clients use this certificate is to set the environmental variable OS_CACERT to
        point to the EPHEMERAL_CA_CERT_FILE that was copied off the seed.</p>

      <p>Now when a service call is made, this cert will be used to authenticate the TLS
        connection:</p>
      <codeblock>nova list</codeblock>
      

      <p>Another option is for the clients not to authenticate TLS connections. This is not advised
        as this will mean the identity of the server you are contacting will not be verified.
        However if you want to bypass this check you can use the --insecure option. A certificate is
        not needed then.</p>
      <codeblock>nova --insecure list</codeblock>
      <p> An endpoint can be either a virtual IP (VIP) or a back-end service URI. A VIP can be
        public, internal or admin. </p>
    </section>
    <section id="TLS_termination"><title>TLS termination for a public endpoint VIP </title> Open the
      following file and change components to tls-components in
      /home/stack/helion/my_cloud/definition/data/network_groups.yml load-balancers:
      <codeblock>   - provider: ip-cluster
     name: extlb                      # This is the external LB.
     external-name: myhelion.test     # change this to a resolvable FQDN
     tls-components:
        - default
     roles:
        - public
          cert-file: my-public-cert   # this cert should match the FQDN for authenticated TLS to work</codeblock>
      What this configuration means: <dl>
        <dlentry>
          <dt>name: extlb</dt>
          <dd>The external Loadbalancer (LB)</dd>
        </dlentry>

        <dlentry>
          <dt>external-name:</dt>
          <dd>This name will be used in place of the external VIP address. This name can be an FQDN.
            This will be registered in the public endpoints of the services. The myhelion.test has
            to be</dd>
        </dlentry>
        <dlentry>
          <dt>tls-components:</dt>
          <dd>This list of services will be put behind TLS. Note this is only being done for the LB
            in question, which is the external LB. The components in ‘default’ are those services
            defined under service-components in data/control_plane.yml. If you want to have a finer
            granularity, you can replace default with a list of individual components, as in:
            <codeblock>tls-components: - 'horizon' </codeblock>
          </dd>
        </dlentry>
        <dlentry>
          <dt>cert-file:</dt>
          <dd> the default my-public-cert is already part of the playbook but you can specify your
            own name. When you specify your own you also need to have the certificate copied in
            ~/helion/my_cloud/config/tls/certs on the deployer. </dd>
        </dlentry>

      </dl> <note>Do not enable TLS to the internal loadbalancer. </note></section>
    <section id="configure_cipher">
      <title>Configuring the cipher suite for public endpoints</title> We have set the default
      cipher suite to be: <codeph>HIGH:!aNULL:!eNULL:!DES:!3DES</codeph>. This is a recommended
      setting from the <xref
        href="http://docs.openstack.org/security-guide/secure-communication/introduction-to-ssl-and-tls.html"
        format="html" scope="external">OpenStack documentation site</xref>.   You may override this.
      Open <b>config/haproxy/defaults.yml</b> and edit it. The parameters would be under
      haproxy_globals list.
      <codeblock>- "ssl-default-bind-ciphers HIGH:!aNULL:!eNULL:!DES:!3DES"
- "ssl-default-server-ciphers HIGH:!aNULL:!eNULL:!DES:!3DES"</codeblock>
      Make the changes as needed. It's best to keep the two options identical. </section>
    <section id="new_cert"><title>Installing a new certificate</title> You should obtain your own
      certificate and install it in the cloud. When this certificate is ready, please do the
      following and rerun the config-processor and reconfigure. Copy the certificate (containing
      both public and private key) to <b>helion/my_cloud/config/tls/certs/ directory</b> </section>
    <section>Update the new certificate filename in cert-file in
        <b>helion/my_cloud/definition/data/network_groups.yml</b>. If you have already run the
      config-processor-run.yml playbook which is required during installation, run the
        <b>config-processor-clean.yml</b> playbook to clear out your previous configuration before
      rerunning the configuration procesor: <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-clean.yml</codeblock>
      <p>Commit your changes to git.</p>
      <codeblock>cd ~/helion/hos/ansible
git add -A
git commit -m "My config or other commit message"</codeblock>
      <p>Rerun the config processor</p>
      <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock>
    </section>
   
    <!-- ===================== horizontal rule ===================== -->
    <!-- Tom Cammann, Thom Leggett- SMEs Nova      -->
  </body>
</topic>
