<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_ijj_45j_nt">
  <title>Replacing a Controller Node</title>
  <body>
    <section>
      <p>For HP Helion OpenStack 2.0 versions, you must have three controller nodes. Therefore,
        adding and removing nodes are not options. However, if you need to repair or replace a
        controller node, you may do so by following the steps outlined here.</p>
      <note>Do not add entries for a new server; instead, just update the entries for the broken
        one. Also note that <p>if you are replacing a control plane node that also happens to be
          running the deployer, that process is different. Youâ€™ll need to restore you deployer data
          first. </p></note>
      <b>Update your model with replacement server information</b>
      <ol>
        <li> Update your cloud model (<b>servers.yml </b>) with new MAC address; server ID; and
          iLO/IPMI user, password, and IP address if these have changed. (Please follow the
          procedure for updating your cloud model/ git repo)</li>
        <li> Get the <b>servers.yml</b> file stored in git:
          <codeblock>cd ~/helion/my_cloud/definition/data
git checkout site</codeblock>then change
          the IP address of this existing controller node and change the MAC address and IPMI/iLO
          info  in <b>servers.yml</b>  if different from what was there previously. Save and commit
          the change <codeblock>git commit -a -m "repaired node X"</codeblock></li>
        <li>Run the configuration processor as follows:
          <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock>
        Then run ready-deployment:
        <codeblock>ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock>
        </li>
      </ol>
      <b>Image the new node</b>
      <ol>
        <li>Log onto the node that is running the deployer. Remove the broken control plane node
          from cobbler by running sudo cobbler system remove --name &lt;server-id>. Here's an
          example:<codeblock> sudo cobbler system remove --name ccp-0001</codeblock>
        </li>
        <li> Re-run the cobbler deploy playbook to re-add the removed node
          <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/localhost cobbler-deploy.yml</codeblock>
        </li>
        <li> Re-image the new nodes by running <b>bm-reimage.yml</b>: ansible-playbook -i
          hosts/localhost bm-reimage.yml -e nodelist=&lt;node-name>. Here's an
          example:<codeblock>ansible-playbook -i hosts/localhost bm-reimage.yml -e nodelist=ccp-0001</codeblock>
        </li>
        <li> Re-deploy the services on the node using ansible-playbook -i hosts/verb_hosts site.yml
          -e rebuild=True --limit=&lt;node_name>. Here's an example:
          <codeblock>ansible-playbook -i hosts/verb_hosts site.yml -e rebuild=True --limit=padawan-ccp-c1-m1-mgmt</codeblock>
        </li>
      </ol>
      <!--
      <ul>
      <li>When the node is ready to be restored, the process for re-introducing it will depend on the
        actions performed to repair it. If it was simply rebooted to introduce new software, etc.
        then running the <b>hlm-start.yml</b> playbook will suffice. If needed, use
        <b>bm-power-up.yml </b>playbook to restart the node. Specify just the node(s) you want
        to start in the 'nodelist' parameter aguments, i.e.
        nodelist=&lt;node1>[,&lt;node2>][,&lt;node3>]
        <codeblock>cd ~/helion/hos/ansible
~/helion/hos/ansible$ ansible-playbook -i hosts/localhost bm-power-up.yml -e nodelist=cpn-0004</codeblock>
      </li><li>Execute the <b>hlm-start.yml </b>playbook. Specifying the node(s) you want to start in the
        'limit' parameter arguments. This parameter accepts wildcard arguments and also
        '@&lt;filename>' to process all hosts listed in the file.
        <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts hlm-start.yml - -limit hlm004-ccp-comp0004-mgmt</codeblock>
      </li><li>If the node has undergone repairs that impact disk contents, then running the
        <b>re-image.yml</b> and <b>hlm-deploy.yml </b>playbooks will be required.
        Run:<codeblock>cd ~/helion/hos/ansible
~/helion/hos/ansible$ ansible-playbook -i hosts/localhost bm-reimage.yml -e nodelist=cpn-0004</codeblock>
      </li><li>Then execute the <b>hlm-start.yml</b> playbook.
        <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts hlm-deploy.yml - -limit hlm004-ccp-comp0004-mgmt</codeblock>
      </li>
      </ul>
      -->
    </section>
  </body>
</topic>
