<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task-wr PUBLIC "-//WindRiver.com//DTD DITA 1.2 Wind River General Task//EN" "task-wr.dtd">
<task-wr domains="(topic task task-wr)                            (topic hi-d)                            (topic pr-d)                            (topic sw-d)                            (topic ui-d)                            (topic wr-sw-d)                            (topic xml-d)   " id="jow1420473404578" xml:lang="en-us" xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/">
<!-- Modification History
        
-->
    <title id="246">Adding an Infrastructure Network Using the CLI</title>
    <shortdesc id="247">If an infrastructure network is not installed during initial
        configuration, you can add one later using the CLI.</shortdesc>
    <prolog>
        <author id="248"/>
    </prolog>
    <taskbody>
        <prereq id="prereq_N10021_N1001E_N10001" id="284">
            <note id="note_N10025_N10021_N1001E_N10001" id="285">
                <p id="286">On a cluster with an infrastructure network, each host must have an
                    infrastructure interface before it can be unlocked. Ensure that all hosts have
                    the required hardware.</p>
            </note>
        </prereq>
        <context id="context_N1001D_N1001A_N10001" id="249">
            <p id="179">For a system with an LVM storage backend, the infrastructure network
                is optional. It can be used to offload the internal management network on clusters
                with many compute nodes. For more information, see <xref href="jow1404333674324.xml" id="180"/>.</p>
            <p id="182">You can view the existing infrastructure network configuration
                using the following command on the active controller (assumed to be <nameliteral id="194">controller-0</nameliteral> for this discussion).</p>
            <codeblock id="164"><systemoutput id="299">~(keystone_admin)$ </systemoutput><userinput id="171">system infra-show</userinput></codeblock>
            <codeblock id="165"><systemoutput id="300">
+--------------+--------------------------------------+
| Property     | Value                                |
+--------------+--------------------------------------+
| uuid         | cc549ef3-5c81-4fbf-8c50-5163c89e5039 |
| istate       | applied                              |
| infra_subnet | None                                 |
| isystem_uuid | 1bbd29be-c6a2-4e9b-93ce-a8dac3ce8e5c |
| recordtype   | reconfig                             |
| created_at   | 2014-12-23T21:15:34.074881+00:00     |
| updated_at   | 2014-12-31T19:38:43.603320+00:00     |
+--------------+--------------------------------------+
</systemoutput></codeblock>
            <p id="287">You can add an infrastructure network after initial installation.
                For this operation, all nodes except the active controller must be locked. During
                the change, the nodes cannot be unlocked until the new configuration is applied to
                both controllers. In addition, before a node can be unlocked, an infrastructure
                interface must be configured on the host.</p>
        </context>
        <steps>
            <step id="step_N1017B_N10178_N1001A_N10001" id="250">
                <cmd id="251">Lock all hosts except the active controller.</cmd>
                <info id="252">
                    <p id="184">For each host, use the following command.</p>
                    <codeblock id="166"><systemoutput id="301">~(keystone_admin)$ </systemoutput><userinput id="172">system host-lock <varname id="185">hostname</varname></userinput></codeblock>
                </info>
            </step>
            <step id="step_N10076_N1004F_N1001E_N10001" id="253">
                <cmd id="254">Add an infrastructure interface on the standby controller.</cmd>
                <info id="255">
                    <p id="186">To add an infrastructure network to a dedicated interface,
                        use the following command, specifying a name for the network and the port to
                        use for the network connection. To identify the port to use for an
                        infrastructure network, consult your configuration plan.</p>
                    <note id="note_N100A0_N10097_N1008D_N10065_N1001E_N10001" id="296">
                        <p id="297">You can also add an infrastructure network to a shared interface as a
                            VLAN-tagged network. For more information, see <xref href="jow1423173019489.xml" id="298"/>.</p>
                    </note>
                    <codeblock id="195"><systemoutput id="302">~(keystone_admin)$ </systemoutput><userinput id="199">system host-if-add -nt infra \
<varname id="201">hostname</varname> <varname id="203">interfacename</varname> <varname id="205">port</varname></userinput></codeblock>
                    <p id="190">For example:</p>
                    <codeblock id="168"><systemoutput id="303">~(keystone_admin)$ </systemoutput><userinput id="174">system host-if-add -nt infra \
controller-1 infra0 eth3</userinput>
<systemoutput id="304">+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| ifname           | infra0                               |
| networktype      | infra                                |
| iftype           | ethernet                             |
| ports            | [u'eth3']                            |
| providernetworks | None                                 |
| imac             | 08:00:27:7a:fa:a5                    |
| imtu             | 1500                                 |
| aemode           | active_standby                       |
| schedpolicy      | None                                 |
| txhashpolicy     | layer2                               |
| uuid             | d3efde57-c475-402e-acad-34f5029f3988 |
| ihost_uuid       | 62657285-cc9c-45a2-962e-ecb01647916f |
| vlan_id          | None                                 |
| uses             | []                                   |
| used_by          | []                                   |
| created_at       | 2014-12-31T20:13:16.326992+00:00     |
| updated_at       | None                                 |
+------------------+--------------------------------------+
</systemoutput></codeblock>
                </info>
            </step>
            <step id="step_N100B8_N1004F_N1001E_N10001" id="256">
                <cmd id="257">Add the same infrastructure network on the active controller.</cmd>
                <info id="258">
                    <p id="192"> For example:</p>
                    <codeblock id="169"><systemoutput id="305">~(keystone_admin)$ </systemoutput><userinput id="175">system host-if-add -nt infra \
controller-0 infra0 eth3</userinput>
<systemoutput id="306">+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| ifname           | infra0                               |
| networktype      | infra                                |
| iftype           | ethernet                             |
| ports            | [u'eth3']                            | 
| providernetworks | None                                 |
| imac             | 08:00:27:51:58:6b                    |
| imtu             | 1500                                 |
| aemode           | active_standby                       |
| schedpolicy      | None                                 |
| txhashpolicy     | layer2                               |
| uuid             | 66c4543e-6bfd-4ede-9b8a-4d091cf290a9 |
| ihost_uuid       | 3c11607b-1550-4e99-a46f-2580c18683da |
| vlan_id          | None                                 |
| uses             | []                                   |
| used_by          | []                                   |
| created_at       | 2014-12-31T20:29:51.759507+00:00     |
| updated_at       | None                                 |
+------------------+--------------------------------------+</systemoutput></codeblock>
                </info>
            </step>
            <step id="step_N100DB_N1004F_N1001E_N10001" id="259">
                <cmd id="260">Specify the infrastructure subnet.</cmd>
                <info id="261">
                    <codeblock id="215"><systemoutput id="307">~(keystone_admin)$ </systemoutput><userinput id="216">system infra-modify \
infra_subnet=<varname id="217">subnet/mask</varname> action=apply</userinput></codeblock>
                    <p id="218">For example:</p>
                    <codeblock id="219"><systemoutput id="308">~(keystone_admin)$ </systemoutput><userinput id="220">system infra-modify \
infra_subnet=192.168.205.0/24 action=apply</userinput>

<systemoutput id="309">+--------------+--------------------------------------+
| Property     | Value                                |
+--------------+--------------------------------------+
| uuid         | cc549ef3-5c81-4fbf-8c50-5163c89e5039 |
| istate       | applying                             |
| infra_subnet | 192.168.205.0/24                     |
| isystem_uuid | 1bbd29be-c6a2-4e9b-93ce-a8dac3ce8e5c |
| recordtype   | reconfig                             |
| created_at   | 2014-12-23T21:15:34.074881+00:00     |
| updated_at   | 2015-01-02T16:06:39.275800+00:00     |
+--------------+--------------------------------------+</systemoutput></codeblock>
                </info>
            </step>
            <step id="step_N10114_N1004F_N1001E_N10001" id="262">
                <cmd id="263">Reboot the standby controller.</cmd>
                <info id="264">
                    <codeblock id="225"><systemoutput id="310">~(keystone_admin)$ </systemoutput><userinput id="226">system host-reboot controller-1</userinput></codeblock>
                    <p id="227">This updates its configuration.</p>
                    <p id="231">Wait for the standby controller to reboot. To monitor its
                        status, use the following command.</p>
                    <codeblock id="290"><systemoutput id="311">~(keystone_admin)$ </systemoutput><userinput id="291">watch -n 5 system host-list</userinput></codeblock>
                    <p id="292">This displays a refreshed host list every five seconds.
                        Monitor the output until the standby controller is shown as <nameliteral id="293">locked</nameliteral> and <nameliteral id="294">online</nameliteral>. To stop monitoring, enter <userinput id="295">CTRL-C</userinput>.</p>
                    <note id="note_N10154_N10139_N1012F_N10065_N1001E_N10001" id="223" type="caution">
                        <p id="224">To prevent potential service conflicts due to
                            inconsistent controller network configurations, do not unlock the
                            standby controller until the active controller is also rebooted.</p>
                    </note>
                </info>
            </step>
            <step id="step_N10149_N1004F_N1001E_N10001" id="265">
                <cmd id="266">Reboot the active controller.</cmd>
                <info id="267">
                    <codeblock id="268"><systemoutput id="312">~(keystone_admin)$ </systemoutput><userinput id="272">sudo reboot</userinput>
<systemoutput id="313">The system is going down for reboot NOW!</systemoutput></codeblock>
                    <p id="236">Wait for the controller to reboot.</p>
                </info>
            </step>
            <step id="step_N10171_N1004F_N1001E_N10001" id="274">
                <cmd id="275">Log in to the active controller and become the Keystone
                        <nameliteral id="237">admin</nameliteral> user.</cmd>
                <info id="276">
                    <codeblock id="269"><systemoutput id="314">$ </systemoutput><userinput id="273">source /etc/nova/openrc</userinput>
</codeblock>
                </info>
            </step>
            <step id="step_N10190_N1004F_N1001E_N10001" id="277">
                <cmd id="278">Unlock the standby controller.</cmd>
                <info id="279">
                    <codeblock id="238"><systemoutput id="315">~(keystone_admin)$ </systemoutput><userinput id="239">system host-unlock controller-1</userinput>
<systemoutput id="316">+-----------------+--------------------------------------+
| Property        | Value                                |
+-----------------+--------------------------------------+
| action          | none                                 |
| administrative  | locked                               |
| availability    | online                               |
| bm_ip           |                                      |
| bm_mac          |                                      |
| bm_type         | None                                 |
| bm_username     |                                      |
| capabilities    | {}                                   |
| created_at      | 2014-12-24T16:44:08.749540+00:00     |
| cstatus         |                                      |
| hostname        | controller-1                         |
| iconfig_applied | 76aa6a81-620a-4ba2-85c3-113d1c42f5ec |
| iconfig_fini    | 76aa6a81-620a-4ba2-85c3-113d1c42f5ec |
| iconfig_target  | 76aa6a81-620a-4ba2-85c3-113d1c42f5ec |
| id              | 5                                    |
| invprovision    | unprovisioned                        |
| location        | {u'locn': u'Rack 1 Pos 2'}           |
| mgmt_ip         | 192.168.204.4                        |
| mgmt_mac        | 08:00:27:ba:e8:52                    |
| operational     | disabled                             |
| personality     | controller                           |
| reserved        | False                                |
| serialid        | None                                 |
| task            | Unlocking                            |
| updated_at      | 2015-01-02T17:12:56.464592+00:00     |
| uptime          | 1955                                 |
| uuid            | 62657285-cc9c-45a2-962e-ecb01647916f |
+-----------------+--------------------------------------+
</systemoutput>
</codeblock>
                </info>
            </step>
            <step id="step_N101B3_N1004F_N1001E_N10001" id="281">
                <cmd id="282">Add infrastructure interfaces to each compute node.</cmd>
                <info id="283">
                    <p id="241">For each node, use the following command.</p>
                    <codeblock id="196"><systemoutput id="317">~(keystone_admin)$ </systemoutput><userinput id="200">system host-if-add -nt infra \
<varname id="202">hostname</varname> <varname id="204">networkname</varname> <varname id="206">port</varname></userinput>
<systemoutput id="318">+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| ifname           | infra0                               |
| networktype      | infra                                |
| iftype           | ethernet                             |
| ports            | [u'eth0']                            |
| providernetworks | None                                 |
| imac             | 08:00:27:20:d2:d1                    |
| imtu             | 1500                                 |
| aemode           | active_standby                       |
| schedpolicy      | None                                 |
| txhashpolicy     | layer2                               |
| uuid             | d664ad66-58fa-4378-b906-ae417d58dbf0 |
| ihost_uuid       | 43b462ac-05fc-43dd-82de-160c7ab0923f |
| vlan_id          | None                                 |
| uses             | []                                   |
| used_by          | []                                   |
| created_at       | 2015-01-02T17:33:37.138694+00:00     |
| updated_at       | None                                 |
+------------------+--------------------------------------+
</systemoutput></codeblock>
                    <p id="243">You can now unlock the compute nodes. This clears any
                            <nameliteral id="244">Configuration out-of-date</nameliteral>
                        errors.</p>
                    <p id="245"><!-- At this point system host-if-show controller-0 eth3 says there is no eth3. . . --></p>
                </info>
            </step>
        </steps>
    </taskbody>
</task-wr>