<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task-wr PUBLIC "-//WindRiver.com//DTD DITA 1.2 Wind River General Task//EN" "task-wr.dtd">
<task-wr domains="(topic task task-wr)                            (topic hi-d)                            (topic pr-d)                            (topic sw-d)                            (topic ui-d)                            (topic wr-sw-d)                            (topic xml-d)   " id="psa1410807838150" xml:lang="en-us" xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/">
<!-- Modification History
        
-->
    <title id="1">Restore Procedure</title>
    <shortdesc id="2">You can restore a HP Helion OpenStack Carrier Grade cluster from
        available system data backup files to bring it back to the operational state it was when the
        backup procedure took place.</shortdesc>
    <prolog>
        <author id="3">Pedro Sanchez</author>
    </prolog>
    <taskbody>
        <context id="context_N1001F_N1001C_N10001" id="4">
            <p id="5">Restoring a HP Helion OpenStack Carrier Grade cluster from a set of
                backup files is done by restoring one host at a time, starting with the controllers,
                then  the compute nodes.</p>
        </context>
        <prereq id="prereq_N1002D_N1001F_N10001" id="8">
            <p id="9">Before you start the restore procedure you must ensure the following conditions are
                in place:</p>
            <ul id="ul_rfq_qfg_mp">
                <li id="10">
                    <p id="11">All cluster hosts must be powered down, just as if they were
                        going to be initialized anew.</p>
                </li>
                <li id="12">
                    <p id="13">All backup files are accessible from a USB flash drive
                        locally attached to the controller where the restore operation takes place
                            (<nameliteral id="172">controller-0</nameliteral>).</p>
                </li>
                <li id="14">
                    <p id="132">You have the HP Helion OpenStack Carrier Grade installation image available on
                        a USB flash drive, just as when the software was installed the first time.
                        It is mandatory that you use the exact same version of the software used
                        during the original installation, otherwise the restore procedure will
                        fail.</p>
                </li>
                <li id="134">
                    <p id="136">The restore procedure requires all hosts but <nameliteral id="138">controller-0</nameliteral> to boot over the internal
                        management network using the PXE protocol, just as it was done during the
                        initial software installation. Ideally, you cleaned up all hard drives in
                        the cluster, and the old boot images are no longer present; the hosts then
                        default to boot from the network when powered on. If this is not the case,
                        you must configure each host manually for network booting right after this
                        exercise asks you to power them on.</p>
                </li>
            </ul>
        </prereq>
        <steps>
            <step id="step_N1002B_N10028_N1001C_N10001" id="6">
                <cmd id="7">Install the HP Helion OpenStack Carrier Grade software on
                        <nameliteral id="140">controller-0</nameliteral> from the USB flash drive.</cmd>
                <info id="20">
                    <p id="21">Refer to the <cite id="241">HP Helion OpenStack Carrier Grade Software Installation Guide</cite> for
                        details.</p>
                </info>
                <stepresult id="23">
                    <p id="24">When the software installation is complete, you should be
                        able to log in using the host's console and the web administration
                        interface.</p>
                </stepresult>
            </step>
            <step id="step_N10085_N1005F_N1001F_N10001" id="25">
                <cmd id="26">Log in to the console as user <nameliteral id="27">wrsroot</nameliteral> with password
                        <nameliteral id="28">wrsroot</nameliteral>.</cmd>
            </step>
            <step id="step_N10096_N1005F_N1001F_N10001" id="29">
                <cmd id="30">Ensure the backup files are available to the controller.</cmd>
                <info id="31">
                    <p id="32">Plug the USB flash drive containing the backup files into the
                        system. The USB flash drive is mounted automatically. Use the command
                            <cmdname id="33">df</cmdname> to list the mount points.</p>
                    <p id="40">The following steps assume that the backup files are
                        available from a USB flash drive mounted in <filepath id="41">/media/wrsroot</filepath> in the directory <filepath id="42">backups</filepath>.</p>
                </info>
            </step>
            <step id="step_N100CB_N1005F_N1001F_N10001" id="43">
                <cmd id="44">Update the controller's software to the previous patching
                    level.</cmd>
                <info id="173">
                    <p id="174">When restoring the system configuration, the current
                        software version on the controller, at this time, the original software
                        version from the ISO image, is compared against the version available in the
                        backup files. They differ if the latter includes patches applied to the
                        controller's software at the time the backup files were created. If
                        different, the restore process automatically applies the patches and forces
                        an additional reboot of the controller to make them effective.</p>
                    <p id="175">The following is the command output if patching is
                        necessary:</p>
                </info>
                <stepxmp id="176">
                    <codeblock id="178"><systemoutput id="250">$ </systemoutput><userinput id="182">sudo config_controller --restore-system \
/media/wrsroot/backups/backup_20140918_system.tgz</userinput>
<systemoutput id="251">Restoring system (this will take several minutes):
Step  4 of 19 [#########                                    ] [21%]
This controller has been patched. A reboot is required.
After the reboot is complete, re-execute the restore command.
Enter 'reboot' to reboot controller:</systemoutput></codeblock>
                    <p id="185">You must enter <nameliteral id="186">reboot</nameliteral> at the prompt as requested. Once the controller is
                        back, log in as user <nameliteral id="187">wrsroot</nameliteral> as
                        before to continue.</p>
                </stepxmp>
                <stepresult id="188">
                    <p id="189">After the reboot, you can verify that the patches were applied, as
                        illustrated in the following example:</p>
                    <codeblock id="190"><systemoutput id="252">$ </systemoutput><userinput id="192">sudo wrs-patch query</userinput>
<systemoutput id="253">        Patch ID          Repo State  Patch State
========================  ==========  ===========
COMPUTECONFIG             Available       n/a
LIBCUNIT_CONTROLLER_ONLY   Applied        n/a</systemoutput></codeblock>
                </stepresult>
            </step>
            <step id="step_N10125_N1006E_N1001F_N10001" id="194">
                <cmd id="195">Restore the system configuration.</cmd>
                <info id="196">
                    <p id="197">The controller's software is up to date now, at the same
                        stage it was when the backup operation was executed. The restore procedure
                        can be invoked again, and should run without interruptions.</p>
                </info>
                <stepxmp id="177">
                    <codeblock id="179"><systemoutput id="254">$ </systemoutput><userinput id="183">sudo config_controller --restore-system \
/media/wrsroot/backups/backup_20140918_system.tgz</userinput>
<systemoutput id="255">Restoring system (this will take several minutes):
Step 19 of 19 [##########################] [100%]
Restoring node states (this will take several minutes):

Locking nodes:Step 10 of 10 [#############################################] [100%]
Powering-off nodes:
Step 10 of 10 [#############################################] [100%]

System restore complete </systemoutput></codeblock>
                </stepxmp>
            </step>
            <step id="step_N100ED_N1005F_N1001F_N10001" id="52">
                <cmd id="53">Authenticate to the system as Keystone user <nameliteral id="54">admin</nameliteral>.</cmd>
                <info id="55">
                    <p id="56">Source the <nameliteral id="57">admin</nameliteral>
                        user environment as follows:</p>
                </info>
                <stepxmp id="58">
                    <codeblock id="59"><systemoutput id="256">$ </systemoutput><userinput id="61">cd; source /etc/nova/openrc</userinput></codeblock>
                </stepxmp>
            </step>
            <step id="step_N10113_N1005F_N1001F_N10001" id="62">
                <cmd id="63">Restore the system images.</cmd>
                <stepxmp id="64">
                    <codeblock id="65"><systemoutput id="257">~(keystone_admin)$ </systemoutput><userinput id="67">sudo config_controller --restore-images \
/media/wrsroot/backups/backup_20140918_images.tgz</userinput>
<systemoutput id="258">Step 2 of 2 [#############################################] [100%]

Images restore complete</systemoutput></codeblock>
                </stepxmp>
                <info id="69">
                    <p id="70">This step assumes that the backup file resides on the
                        attached USB drive. If instead you copied the image backup file to the
                            <filepath id="199">/opt/backups</filepath> directory, for example using the
                            <cmdname id="200">scp</cmdname> command, you can remove it now.</p>
                </info>
            </step>
            <step id="step_N10135_N1005F_N1001F_N10001" id="71">
                <cmd id="72">Restore <nameliteral id="73">controller-1</nameliteral>.</cmd>
                <substeps id="substeps_wt4_5dh_mp">
                    <substep id="74">
                        <cmd id="75">List the current state of the hosts.</cmd>
                        <stepxmp id="76">
                            <codeblock id="77"><systemoutput id="259">~(keystone_admin)$ </systemoutput><userinput id="79">system host-list</userinput>
<systemoutput id="260">+----+--------------+-------------+----------------+-------------+--------------+
| id | hostname     | personality | administrative | operational | availability |
+----+--------------+-------------+----------------+-------------+--------------+
| 1  | controller-0 | controller  | unlocked       | enabled     | available    |
| 2  | controller-1 | controller  | locked         | disabled    | offline      |
| 3  | compute-0    | compute     | locked         | disabled    | offline      |
+----+--------------+-------------+----------------+-------------+--------------+</systemoutput></codeblock>
                        </stepxmp>
                    </substep>
                    <substep id="81">
                        <cmd id="82">Power on the host.</cmd>
                        <info id="83">
                            <p id="84">Remember to ensure that the host boots from the
                                network and not from an old disk image that might still be present
                                on its hard drive.</p>
                        </info>
                    </substep>
                    <substep id="85">
                        <cmd id="86">Unlock the host.</cmd>
                        <stepxmp id="87">
                            <codeblock id="88"><systemoutput id="261">~(keystone_admin)$ </systemoutput><userinput id="90">system host-unlock 2</userinput>
<systemoutput id="262">+-----------------+--------------------------------------+
| Property        | Value                                |
+-----------------+--------------------------------------+
| action          | none                                 |
| administrative  | locked                               |
| availability    | online                               |
| ...             | ...                                  |
| uuid            | 5fc4904a-d7f0-42f0-991d-0c00b4b74ed0 |
+-----------------+--------------------------------------+</systemoutput></codeblock>
                        </stepxmp>
                    </substep>
                    <substep id="92">
                        <cmd id="93">Verify the new state of the hosts.</cmd>
                        <stepxmp id="94">
                            <codeblock id="95"><systemoutput id="263">~(keystone_admin)$ </systemoutput><userinput id="97">system host-list</userinput>
<systemoutput id="264">+----+--------------+-------------+----------------+-------------+--------------+
| id | hostname     | personality | administrative | operational | availability |
+----+--------------+-------------+----------------+-------------+--------------+
| 1  | controller-0 | controller  | unlocked       | enabled     | available    |
| 2  | controller-1 | controller  | unlocked       | enabled     | available    |
| 3  | compute-0    | compute     | locked         | disabled    | offline      |
+----+--------------+-------------+----------------+-------------+--------------+</systemoutput></codeblock>
                        </stepxmp>
                    </substep>
                </substeps>
                <stepresult id="99">
                    <p id="100">The unlocking operation forces a reboot of the host, which
                        is then initialized with the corresponding image available from the system
                        backup.</p>
                    <p id="201">You must wait for the host to become enabled and available
                        before proceeding to the next step.</p>
                </stepresult>
            </step>
            <step id="step_N101ED_N1005F_N1001F_N10001" id="118">
                <cmd id="119">Restore the compute nodes, one at a time.</cmd>
                <info id="120">
                    <p id="121">You restore these hosts following the same procedure used to
                        restore <nameliteral id="122">controller-1</nameliteral>.</p>
                </info>
                <stepresult id="123">
                    <p id="124">The state of the hosts when the restore operation is
                        complete is as follows:</p>
                    <codeblock id="125"><systemoutput id="276">~(keystone_admin)$ </systemoutput><userinput id="127">system host-list</userinput>
<systemoutput id="277">+----+--------------+-------------+----------------+-------------+--------------+
| id | hostname     | personality | administrative | operational | availability |
+----+--------------+-------------+----------------+-------------+--------------+
| 1  | controller-0 | controller  | unlocked       | enabled     | available    |
| 2  | controller-1 | controller  | unlocked       | enabled     | available    |
| 3  | compute-0    | compute     | unlocked       | enabledd    | available    |
+----+--------------+-------------+----------------+-------------+--------------+</systemoutput></codeblock>
                    <p id="129">As each compute node is restored, the original instances at the time the
                        backups were done are started automatically.</p>
                </stepresult>
            </step>
        </steps>
        <result id="result_N10213_N1001F_N10001" id="130">
            <p id="131">The system is fully restored. The state of the system, including
                virtual machines, is identical to the state the cluster was in when the backup
                procedure took place.</p>
            <p id="171">Remember however, that passwords for local user accounts must be
                restored manually since they are not included as part of the backup and restore
                procedures. See <xref href="jow1404333563834.xml" id="242"/> for additional
                information.</p>
        </result>
    </taskbody>
</task-wr>
